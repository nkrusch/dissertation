%-------------------------------------------------------------------------------
% Formatting options and style overrides
%-------------------------------------------------------------------------------

%% Sections begin on a new page (but in some cases we need a toggle)
% https://tex.stackexchange.com/a/629027/233737
\AddToHook{cmd/section/before}[./section-new]{\clearpage}
\AddToHook{cmd/section/before}[./section-flow]{}
\newcommand\newsect{\ClearHookRule{cmd/section/before}{./section-new}{./section-flow}}
\newcommand\newsectoff{\DeclareHookRule{cmd/section/before}{./section-flow}{voids}{./section-new}}
\newsect % initially on

%% Boolean flag to detect placement in appendix
\newbool{inappendix}
\appto{\appendix}{\booltrue{inappendix}}

% autorefs
\AtBeginDocument{%
\renewcommand{\chapterautorefname}{\S\kern-3pt}
\renewcommand{\appendixautorefname}{\S\kern-3pt}
\renewcommand{\sectionautorefname}{\S\kern-3pt}
\renewcommand{\subsectionautorefname}{\S\kern-3pt}
\renewcommand{\subsubsectionautorefname}{\S\kern-3pt}
\renewcommand{\theoremautorefname}{Thm.}
\renewcommand{\definitionautorefname}{Def.}
\renewcommand{\exampleautorefname}{Ex.}
\renewcommand{\figureautorefname}{Fig.}
\newcommand{\algorithmautorefname}{Algorithm}
\renewcommand{\notationautorefname}{Notation}
}

\makeatletter
\renewcommand*\l@section{\@dottedtocline{1}{1.5em}{1.6em}}
\renewcommand*\l@subsection{\@dottedtocline{2}{3.1em}{2.7em}}
\makeatother

% Theorem styles
\AtBeginEnvironment{theorem}{\pushQED{\qed}}
\AtEndEnvironment{theorem}{\hfill\popQED\endexample}
\AtBeginEnvironment{example}{\pushQED{\qed}}
\AtEndEnvironment{example}{\hfill\popQED\endexample}
\AtBeginEnvironment{definition}{\pushQED{\qed}}
\AtEndEnvironment{definition}{\hfill\popQED\enddefinition}

% Algorithms
\algtext*{EndWhile} % Remove "end while" text
\algtext*{EndIf} % Remove "end if" text
\algrenewcommand\alglinenumber[1]{\color{sviolet}\footnotesize #1\hspace{1em}}

% set min-length for dot-fill
\newcommand\mydotfill{%
\leavevmode
\mbox{}\cleaders\hbox to.44em{\hss.\hss}\hskip 0.88em plus 1fill
\kern0pt }
\newcommand\ldotfill{%
\leavevmode
\mbox{}\leaders\hbox to.44em{\hss.\hss}\hskip 0.64em plus 1fill
\kern0pt }

% Term Index
\makeatletter
\renewenvironment{theindex}
{{\chapter{\indexname}\label{sec:app:index}}\par%
\@mkboth{\MakeUppercase\indexname}{\MakeUppercase\indexname}%
\parindent\z@
\parskip\z@ \@plus .5\p@\relax
\let\item\@idxitem
\setlength{\columnsep}{30pt}
\setlength{\parindent}{0em}
\begin{multicols*}{2}\raggedcolumns\raggedleft}
{\end{multicols*}}
%\let\item\@idxitem}
{\clearpage}
\renewcommand{\@idxitem}{\par\hangindent 15\p@}
\renewcommand{\subitem}{\par\hangindent 30\p@\hspace*{15pt}}
\makeatother

\begin{filecontents}{\jobname.mst}
headings_flag 1
heading_prefix "\{\\normalsize\\textbf\{"
heading_suffix "\}\}\\hfill\\nopagebreak\n"
delim_0 "\\mydotfill\{\\footnotesize"
delim_1 "\\mydotfill\{\\footnotesize"
delim_2 "\\mydotfill\{\\footnotesize"
delim_t "\}"
\end{filecontents}

%% Glossaries
% custom glossary style, match index
\renewcommand{\glsdescwidth}{12.5cm}
\newglossarystyle{longraggeddots}{
    \setglossarystyle{longragged}%
    \renewenvironment{theglossary}%
    {\begin{longtable}{@{}l>{\hangindent15pt\hangafter=1\raggedleft}p{\glsdescwidth}}}%
    {\end{longtable}}%
    \renewcommand*{\glossentry}[2]{%
       \glstarget{##1}{\glossentryname{##1}} &
       \glossentrydesc{##1}\mydotfill\footnotesize{##2}\tabularnewline
   }
   \renewcommand{\subglossentry}[3]{%
    &
    \glssubentryitem{##2}%
    {\footnotesize\emph{also}}\hspace{5pt}\glstarget{##2}{\strut}\glossentrydesc{##2}%
    \glspostdescription\mydotfill\footnotesize{##3}\tabularnewline
  }
}
\setglossarystyle{longraggeddots}

%% Patch glossary hyperref
% https://tex.stackexchange.com/a/40121/233737
\makeatletter
\patchcmd{\@glossarysection}{%
    \@@glossaryseclabel%
}{%
    \@@glossaryseclabel%
    \label{\glsautoprefix\@glo@type}
}{}{}
\makeatother


%% Controls for additional double spacing
% Double-space: abstract, dedication, acknowledgements, table of contents, and
% body of the manuscript; except for quotations as paragraphs, captions,
% items in tables, lists, graphs, charts.
% Single-space: footnotes/endnotes, bibliographic entries, lists in appendices.
% ---
% double space various environments:
\mdfsetup{startinnercode={\doublespacing}}
\AtBeginEnvironment{algorithmic}{\doublespacing}
\AtBeginEnvironment{tabular}{\ifbool{inappendix}{\doublespacing}{\doublespacing}}
\AtBeginEnvironment{tabularx}{\ifbool{inappendix}{\doublespacing}{\doublespacing}}
\AtBeginEnvironment{NiceTabular}{\ifbool{inappendix}{\doublespacing}{\doublespacing}}
\AtBeginEnvironment{NiceTabularX}{\ifbool{inappendix}{\doublespacing}{\doublespacing}}
\AtBeginEnvironment{figure}{\doublespacing}
\AtBeginEnvironment{subfigure}{\doublespacing}
\AtBeginEnvironment{align*}{\linespread{2}\selectfont}
\AtBeginEnvironment{infobox}{\doublespacing}
%… but NOT matrices
\BeforeBeginEnvironment{pNiceMatrix}{\renewcommand{\arraystretch}{0.67}}
\AfterEndEnvironment{pNiceMatrix}{\renewcommand{\arraystretch}{\doublespacing}}
%… and NOT footnotes, captions
\renewcommand{\footnotelayout}{\setstretch{1}}
\setlength{\footnotemargin}{2mm}
\setlength{\footnotesep}{\baselineskip}
\DeclareCaptionJustification{capspacing}{\singlespacing}
\captionsetup{justification=capspacing}

% Framed environments setup
\mdfsetup{
    skipabove=1em,
    skipbelow=1em,
    leftmargin=0,
    rightmargin=0,
    innertopmargin=1em,
    innerbottommargin=1em,
    linewidth=1.5pt,   % same as listings
    linecolor=sbase01, % dark grey frames
}

% red squiggly underline
\makeatletter
\def\uwave{\bgroup \markoverwith{\lower3.5\p@\hbox{\sixly \textcolor{dafnyred}{\char58}}}\ULon}
\font\sixly=lasyb10
\makeatother

% Put a dot after paragraph titles.
\makeatletter
%! suppress = MightBreakTexify
\renewcommand\paragraph{%
    \@startsection{paragraph}
    {4}
    {\z@}
    {3.25ex \@plus1ex \@minus.2ex}
    {-1em}
    {\normalfont\normalsize\bfseries\maybe@addperiod}%
}
\newcommand{\maybe@addperiod}[1]{%
    #1\@addpunct{.}%
}
\makeatother

% Some additional breaking for long URLs
\expandafter\def\expandafter\UrlBreaks\expandafter{\UrlBreaks%  save the current one
\do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j%
\do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t%
\do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D%
\do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N%
\do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X%
\do\Y\do\Z}